#!/usr/bin/sh
mkdir -p dist

# Minified and stripped CullJS production build
cd js/lib/culljs
npm install
node build -s -n
cd ../../..

# Minified and stripped Dome production build
cd js/lib/dome
npm install
node build -s -n
cd ../../..

# Combine 'em all
cat \
    js/lib/culljs/dist/cull.js \
    js/lib/dome/dist/dome.js \
    js/lib/spin.js/spin.js \
    js/lib/when/when.js \
    js/lib/bane/lib/bane.js \
    js/lib/reqwest/reqwest.js \
    js/lib/uinit/lib/uinit.js \
    js/lib/showdown/src/showdown.js \
    js/lib/timeago/timeago.js | ./node_modules/.bin/uglifyjs > dist/gitorious3-dependencies.min.js

du -sh dist/gitorious3-dependencies.min.js

cat \
    js/src/app.js \
    js/src/cache.js \
    js/src/json-request.js \
    js/src/components/dropdown.js \
    js/src/components/ganalytics.js \
    js/src/components/abbrev.js \
    js/src/components/url.js \
    js/src/components/ref-selector.js \
    js/src/components/tree-history.js \
    js/src/components/commit-linker.js \
    js/src/components/user-repo-view-state.js \
    js/src/components/profile-menu.js \
    js/src/components/clone-url-selection.js \
    js/src/components/blob.js \
    js/src/components/live-markdown-preview.js \
    js/src/components/timeago.js \
    js/src/components/collapse.js \
    js/src/components/repository-admin.js \
    js/src/components/rails-links.js \
    js/src/components/clone-name-suggestion.js \
    js/src/components/loading.js \
    js/src/components/ref-oid-interpolator.js \
    js/src/gitorious.js | ./node_modules/.bin/uglifyjs > dist/gitorious3-modules.min.js

du -sh dist/gitorious3-modules.min.js

cat \
    dist/gitorious3-dependencies.min.js \
    dist/gitorious3-modules.min.js > dist/gitorious3.min.js

du -sh dist/gitorious3.min.js

cat \
    js/lib/raphael/raphael-min.js \
    js/src/spacer.js \
    js/lib/capillary/lib/capillary.js \
    js/lib/capillary/lib/capillary/branch.js \
    js/lib/capillary/lib/capillary/graph.js \
    js/lib/capillary/lib/capillary/formatters/scale.js \
    js/lib/capillary/lib/capillary/formatters/svg-data.js \
    js/lib/capillary/lib/capillary/formatters/raphael.js \
    js/lib/capillary/lib/capillary/formatters/message-markup.js \
    js/src/components/capillary.js \
    js/src/capillary.js | ./node_modules/.bin/uglifyjs > dist/gitorious3-capillary.min.js

du -sh dist/gitorious3-capillary.min.js
